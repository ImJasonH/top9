<html>
<head>
<title>Top 9 Posts of 2016</title>
<script type="text/javascript">
if (window.location.hash.startsWith('#access_token=')) {
  var tok = window.location.hash.substr('#access_token='.length);
  window.opener.oauthDone(tok);
  window.location.hash = '';
  window.close(); // close this window.
}
</script>
<style>
body {
  font-family: 'Arial';
}

div#container, div#login-container {
  width: 90%;
  margin: auto;
}

button#login {
  width: 300px;
  height: 100px;
  margin: auto;
  display: block;
  background-color: green;
  color: white;
  font-size: 20px;
}

h1, h3 {
  text-align: center;
}

input:invalid {
  border: red 1px solid;
}

canvas {
  cursor: pointer;
  width: auto;
}
</style>
</head>
<body>
<div id="login-container">
  <h1>Share your top 9 posts on Instagram</h1>
  <button id="login">Login to Instagram to get started</button>
</div>

<div id="container">
  <h3>Here's your Top 9! Click to save and share</h3>
  <canvas id="canvas"></canvas>

<form action="javascript:void(0);">
  <input type="text" id="search" list="searchfill" placeholder="Search for other users"></input>
  <datalist id="searchfill"></datalist><button id="searchsubmit">Search Users</button>
</form>
</div>
</div>
</body>
<script type="text/javascript">
var _CURRENT_CALLBACK = null;
function jsonpCallback(resp) {
  if (_CURRENT_CALLBACK) {
    _CURRENT_CALLBACK(resp);
    let head = document.getElementsByTagName('head')[0];
    head.removeChild(head.lastChild); // remove just-added <script> tag.
  } else {
    console.error('Got JSONP callback with no callback', resp);
  }
}

var _ACCESS_TOKEN = localStorage.getItem('accessToken');
if (_ACCESS_TOKEN == null) {
  document.getElementById('container').style.display = 'none';
  var login = document.getElementById('login');
  login.onclick = function() {
    const _CLIENT_ID = 'da2761c2a48c4273b37932f89cd0f35a';
    var url = 'https://api.instagram.com/oauth/authorize/?client_id='+_CLIENT_ID+'&redirect_uri='+window.location+'&scope=basic+public_content&response_type=token';
    var w = window.open(url);
  };
  login.ontouchstart = login.onclick;
} else {
  document.getElementById('login-container').style.display = 'none';
  authed();
}

function oauthDone(tok) {
  _ACCESS_TOKEN = tok;
  localStorage.setItem('accessToken', tok);
  document.getElementById('login-container').style.display = 'none';
  document.getElementById('container').style.display = 'block';
  authed();
}

function authed() {
  fetchAll('self', showImages);
}

function showImages(all) {
  if (all.length < 9) {
    alert('Not enough images to make a Top 9');
    return;
  }

  all.sort(function(a, b) {
    var al = a.likes;
    var bl = b.likes;
    if (al > bl) { return -1; }
    if (al < bl) { return 1; }
    return 0;
  });
  var top = all.slice(0,9);

  var c = document.getElementById('canvas');
  const size = window.innerWidth * .5;
  c.height = size;
  c.width = size;
  var ctx = c.getContext('2d');
  ctx.fillStyle = 'red';
  ctx.strokeStyle = 'white';
  ctx.font = '30px sans-serif';
  var draw = function(i) {
    var img = new Image();
    var x = (size/3)*(i%3);
    var y = (size/3)*Math.floor(i/3);
    img.addEventListener('load', function() {
      ctx.drawImage(img, x, y, (size/3), (size/3));
      // TODO: optionally add # of likes.
      //var text = top[i].likes + '❤';
      //ctx.fillText(text, x+10, y+40);
      //ctx.strokeText(text, x+10, y+40);
    });
    img.setAttribute('crossOrigin', 'anonymous');
    img.src = top[i].img;
  };
  for (var i = 0; i < top.length; i++) {
    draw(i);
  }
  c.onclick = function() {
    var a = document.createElement('a');
    a.href = c.toDataURL('image/jpeg');
    a.download = 'top9';
    a.click();
  }
  c.ontouchstart = c.onclick;
}

var search = document.getElementById('search');
var searchfill = document.getElementById('searchfill');
function clearSearchFill() {
  while (searchfill.firstChild) {
    searchfill.removeChild(searchfill.firstChild);
  }
}
search.oninput = function(e) {
  search.setCustomValidity('');
  clearSearchFill();
  if (search.value.length <= 3) {
    return;
  }
  searchUsers(search.value, function(resp) {
    if (resp.data.length == 0) {
      search.setCustomValidity('No matching users');
      search.reportValidity();
      return;
    }
    for (var i = 0; i < resp.data.length; i++) {
      var opt = document.createElement('option');
      opt.value = resp.data[i].username;
      searchfill.appendChild(opt);
    }
  });
};
document.getElementById('searchsubmit');
searchsubmit.onclick = function() {
  var text = search.value;
  if (text.length == 0) {
    return;
  }
  searchUsers(text, function(resp) {
    if (resp.data.length == 0) {
      search.setCustomValidity('No such user');
      search.reportValidity();
      return;
    }
    fetchAll(text, showImages);
  });
};
search.onsubmit = searchsubmit.onclick;

function searchUsers(str, cb) {
  var url = 'https://api.instagram.com/v1/users/search?q='+str;
  fetch(url, cb);
}

_YEAR = 2016;
function fetchAll(user, cb) {
  var all = [];
  var maxId = '';
  var url = 'https://api.instagram.com/v1/users/'+user+'/media/recent/?count=100';
  var add = function(resp) {
    for (var i = 0; i < resp.data.length; i++ ) {
      var item = resp.data[i];
      var ts = parseInt(item.created_time)*1000;
      var cutoff = new Date(_YEAR, 0).getTime();
      if (ts < cutoff) {
        cb(all);
        return;
      }
      if (item.type == 'image') {
        all.push({
          'img':   item.images.standard_resolution.url,
          'likes': item.likes.count,
          'date': new Date(parseInt(item.created_time)*1000),
        });
      }
    }
    if (resp.pagination.next_url != undefined) {
      fetch(resp.pagination.next_url, add);
    } else {
      cb(all);
      return;
    }
  };
  fetch(url, add);
}

function fetch(url, cb) {
  let add = '?';
  if (url.includes('?')) {
    add = '&';
  }
  _CURRENT_CALLBACK = cb;
  var s = document.createElement('script');
  s.type = 'text/javascript';
  s.async = true;
  s.src = url+add+'access_token='+_ACCESS_TOKEN+'&callback=jsonpCallback';
  document.getElementsByTagName('head')[0].appendChild(s);
}
</script>
</html>
