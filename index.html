<html>
<body>
  <button id="login">Login to Instagram</button>
  <input type="text" id="search" placeholder="Search for users"></input>
</body>
<script type="text/javascript">
if (window.location.hash.startsWith('#access_token=')) {
  var tok = window.location.hash.substr('#access_token='.length);
  window.opener.oauthDone(tok);
  window.location.hash = '';
  window.close(); // close this window.
}

var _CURRENT_CALLBACK = null;
function jsonpCallback(resp) {
  if (_CURRENT_CALLBACK) {
    _CURRENT_CALLBACK(resp);
    let head = document.getElementsByTagName('head')[0];
    head.removeChild(head.lastChild); // remove just-added <script> tag.
  } else {
    console.error('Got JSONP callback with no callback', resp);
  }
}

var _ACCESS_TOKEN = localStorage.getItem('accessToken');
if (_ACCESS_TOKEN == null) {
  document.getElementById('search').style.display = 'none';
  document.getElementById('login').onclick = function() {
    const _CLIENT_ID = 'bc261551ba8447d9b84c7586dbce10f7';
    var url = 'https://api.instagram.com/oauth/authorize/?client_id='+_CLIENT_ID+'&redirect_uri='+window.location+'&response_type=token'+'&scope=basic+public_content';
    var w = window.open(url);
  };
} else {
  document.getElementById('login').style.display = 'none';
  authed();
}

document.getElementById('search').onchange = function(e) {
  console.log(e.target.value);
  fetchAll(e.target.value, showImages);
};

function oauthDone(tok) {
  _ACCESS_TOKEN = tok;
  localStorage.setItem('accessToken', tok);
  document.getElementById('login').style.display = 'none';
  authed();
}

function authed() {
  fetchAll('self', showImages);
}

function showImages(all) {
  all.sort(function(a, b) {
    var al = a.likes;
    var bl = b.likes;
    if (al > bl) { return -1; }
    if (al < bl) { return 1; }
    return 0;
  });
  var top = all.slice(0,9);
  // TODO: Combine into one image.
  for (var i = 0; i < top.length; i++) {
    var img = document.createElement('img');
    img.src = top[i].img;
    img.alt = top[i].likes + ' likes';
    document.body.appendChild(img);
  }
}

_YEAR = 2016;
function fetchAll(user, cb) {
  var all = [];
  var maxId = '';
  var url = 'https://api.instagram.com/v1/users/'+user+'/media/recent/?count=100';
  var add = function(resp) {
    for (var i = 0; i < resp.data.length; i++ ) {
      var item = resp.data[i];
      var ts = parseInt(item.created_time)*1000;
      var cutoff = new Date(_YEAR, 0).getTime();
      if (ts < cutoff) {
        cb(all);
        return;
      }
      if (item.type == 'image') {
        all.push({
          'img':   item.images.standard_resolution.url,
          'likes': item.likes.count,
          'date': new Date(parseInt(item.created_time)*1000),
        });
      }
    }
    if (resp.pagination.next_url != undefined) {
      fetch(resp.pagination.next_url, add);
    } else {
      cb(all);
      return;
    }
    // TODO: keep paginating.
  };
  fetch(url, add);
}

function fetch(url, cb) {
  let add = '?';
  if (url.includes('?')) {
    add = '&';
  }
  _CURRENT_CALLBACK = cb;
  var s = document.createElement('script');
  s.type = 'text/javascript';
  s.async = true;
  s.src = url+add+'access_token='+_ACCESS_TOKEN+'&callback=jsonpCallback';
  document.getElementsByTagName('head')[0].appendChild(s);
}
</script>
</html>
